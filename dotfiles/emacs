;; adds MELPA repos
;;;;;;;;;;;;;;;;;;;
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/"))
(package-initialize)

;; Base changes
;;;;;;;;;;;;;;;
(use-package emacs
  :custom
    (split-height-threshold nil)
    (split-width-threshold 160)
    (inhibit-startup-screen t)
    (scheme-program-name "\guile")
    (httpd-port 8888)
  :bind
    ("<f5>" . recompile)
    ("C-M-j" . join-line)
  :config
    (put 'python-shell-process-environment 'safe-local-variable
      (lambda (v) '(string-prefix-p "DJANGO_SETTINGS_MODULE=" v)))
    (put 'elpy-test-runner 'safe-local-variable (lambda (_) t))
    (put 'downcase-region 'disabled nil)
  :hook
    (after-init . global-auto-revert-mode)
    (after-init . global-company-mode))

(use-package hideshow
  :hook
    (prog-mode . hs-minor-mode))

(use-package whitespace
  :custom
    (whitespace-style '(face tabs trailing lines-tail space-before-tab missing-newline-at-eof empty tab-mark))
  :hook
    (after-init . global-whitespace-mode)
    (before-save . delete-trailing-whitespace))

(use-package better-defaults
  :ensure t)

; ;; Completion/minibuffer
; ;;;;;;;;;;;;;;;;;;;;;;;;

(use-package ivy
  :ensure t
  :custom
    (ivy-use-virtual-buffers t)
    (ivy-count-format "(%d/%d) ")
  :config
    (ivy-mode 1))

(use-package ivy-rich
  :ensure t
  :config
    (ivy-rich-mode 1))

(use-package counsel
  :ensure t
  :defer t
  :bind
    ("C-x M-f" . counsel-fzf)
  :config
    (setq ivy-initial-inputs-alist nil)
    (counsel-mode))

; ;; Packages used by other packages
; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(use-package eglot
  :ensure t
  :defer t
  :config
    (add-to-list 'eglot-server-programs
      '((rust-ts-mode rust-mode) .
       ("rust-analyzer" :initializationOptions (:check (:command "clippy"))))))

(use-package f
  :ensure t
  :defer t)

(use-package flycheck
  :ensure t
  :defer t
  :hook
    (after-init . global-flycheck-mode))

(use-package pdf-tools
  :ensure t
  :defer t)


; ;; modes for diferent filetypes
; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(use-package dts-mode
  :ensure t
  :defer t
  :mode ("\\.dts\\'" "\\.dtsi\\'"))

(use-package flymake-shellcheck
  :ensure t
  :defer t
  :hook
  (sh-mode-hook . flymake-shellcheck-load))

(use-package glsl-mode
  :ensure t
  :defer t)

(use-package markdown-mode
  :ensure t
  :defer t)

(use-package js2-mode
  :ensure t
  :defer t
  :mode "\\.js\\'")

(use-package skewer-mode
  :ensure t
  :defer t
  :hook
    (js2-mode . skewer-mode))

(use-package yaml-mode
  :ensure t
  :defer t
  :mode "\\.yml\\'")


; ; python
; ;;;;;;;;

(use-package elpy
  :ensure t
  :defer t
  :custom
    (elpy-formatter "black")
    (elpy-rpc-virtualenv-path 'current)
  :hook
    (elpy-mode . flycheck-mode)
  :init
    (advice-add 'python-mode :before 'elpy-enable)
  :config
    (setq elpy-modules (delq 'elpy-module-flymake elpy-modules)))

(use-package blacken
  :ensure t
  :defer t
  :after elpy
  :bind
    (:map elpy-refactor-map
      ; This currently does not show up as an option in the minibuffer, but works.
      ("f" . blacken-buffer)))

(defun ssbb-pyenv-auto ()
  "Automatically activates pyenv version if .python-version file exists."
  (f-traverse-upwards
   (lambda (path)
     (let ((pyenv-version-path (f-expand ".python-version" path)))
       (if (f-exists? pyenv-version-path)
          (pyenv-mode-set (s-trim (f-read-text pyenv-version-path 'utf-8))))))))

(use-package pyenv-mode
 :ensure t
 :defer t
 :requires f
 :after elpy
 :hook
   (elpy-mode . pyenv-mode)
   (elpy-mode . ssbb-pyenv-auto))


; ; Rust
; ;;;;;;

; (require 'rust-mode)
; (add-hook 'rust-mode-hook (lambda () (setq indent-tabs-mode nil)))
; (add-hook 'rust-mode-hook 'eglot-ensure)

(use-package rust-mode
  :ensure t
  :defer t
  :after eglot
  :hook
    (rust-mode . (lambda () (setq indent-tabs-mode nil)))
    (rust-mode-hook . eglot-ensure))

(use-package flycheck-rust
  :ensure t
  :after rust-mode
  :hook
    (flycheck-mode . flycheck-rust-setup))


; ; org-mode
; ;;;;;;;;;;
(use-package org
  :ensure t
  :defer t
  :custom ((org-directory (file-truename "~/org"))
           (org-default-notes-file (concat org-directory "/roam/inbox.org"))
           (org-agenda-files (directory-files-recursively org-directory "\\.org$"))
           (org-complete-tags-always-offer-all-agenda-tags t)
           (org-attach-store-link-p 'attached)
           (org-cycle-separator-lines -1)
           (org-display-inline-images t)
           (org-special-ctrl-a/e t)
           (org-pretty-entities t)
           (org-use-sub-superscripts "{}")
           (org-hide-emphasis-markers t))
  :hook ((org-mode . org-indent-mode)
         (org-mode . (lambda ()
           (setq-local whitespace-line-column 9999))))
  :config (org-babel-do-load-languages
           'org-babel-load-languages
           '((C . t)
             (python . t)
             (shell . t)))
          (require 'org-roam)
          (add-to-list 'org-capture-templates
                       '("v" "video" entry
                         (file+headline org-default-notes-file "Inbox")
                         (function get-yt-template)
                            :empty-lines 1
                            :empty-lines-before 2))
  :bind (("C-c C-g l" . org-store-link)
         ("C-c C-g a" . org-agenda)
         ("C-c C-g c" . org-capture)
         (:map org-mode-map
           ("C-c C-q" . counsel-org-tag))))

(with-eval-after-load 'org-roam
  (defun get-yt-template ()
    "Create org-capture template from youtube link"
    (shell-command-to-string
     (format
      "video-info \"%s\" 2> /dev/null"
      (read-string "Youtube Link:")))))

(use-package org-roam
  :ensure t
  :defer t
  :custom
    (org-roam-directory (concat org-directory "/roam"))
    (org-roam-completion-everywhere t)
    (org-roam-dailies-capture-templates
      '(("d" "default" plain "** %?"
         :target (file+head+olp "%<%Y-%m-%d>.org" ":PROPERTIES:\n:ID:       ${org-roam-node-id}\n:END:\n#+title: %<%Y-%m-%d>\n#+filetags: :daily:\n" ("Inbox"))
         :empty-lines 1
         :empty-lines-before 2)))
    (org-roam-node-display-template
      (concat "${title:*} "
        (propertize "${tags:50}" 'face 'org-tag)))
  :config
    (org-roam-db-autosync-mode)
    (add-to-list 'display-buffer-alist
      '("\\*org-roam\\*"
        (display-buffer-in-side-window)
        (side . right)
        (slot . 0)
        (window-width . 0.33)
        (window-parameters . ((no-other-window . t)
          (no-delete-other-windows . t)))))
    (require 'org-roam-dailies)
  :bind
    ((:map org-mode-map
      (("C-c n f" . org-roam-node-find)
       ("C-c n i" . org-roam-node-insert)
       ("C-c n r" . org-roam-refile)
       ("C-c n l" . org-roam-buffer-toggle))))
  :bind-keymap
    ("C-c C-g d" . org-roam-dailies-map))

(use-package org-download
  :ensure t
  :defer t
  :after org
  :custom
    (org-download-method 'attach)
    (org-download-heading-lvl nil)
    (org-download-timestamp "%Y-%m-%d_%H-%M-%S_")
    (org-startup-with-inline-images t)
  :bind
    (:map org-mode-map
      (("s-Y" . org-download-clipboard)
       ("s-y" . org-download-yank))))

(use-package org-noter
  :ensure t
  :defer t)

(use-package org-appear
  :ensure t
  :defer t
  :custom
    (org-appear-autolinks t)
  :hook
    (org-mode . org-appear-mode))

(use-package org-modern
  :ensure t
  :defer t
  :custom
    (org-modern-fold-stars '(("▸" . "▾") ("▸" . "▾") ("▸" . "▾") ("▸" . "▾") ("▸" . "▾")))
  :hook
    (org-mode . org-modern-mode))


; ;; Inferior programs
; ;;;;;;;;;;;;;;;;;;;;
(use-package magit
  :ensure t
  :defer t
  :custom
    (magit-blame-echo-style 'headings)
  :bind
    ("C-x g" . magit-status)
    ("C-x M-g" . magit-dispatch)
  :hook
    (git-commit-setup . git-commit-turn-on-flyspell))


; ;; Misc
; ;;;;;;;
(use-package expand-region
  :ensure t
  :defer t
  :bind
    ("C-=" . er/expand-region))


; ;; UI customization
; ;;;;;;;;;;;;;;;;;;;;
(use-package display-line-numbers
  :ensure t
  :defer t
  :hook
    (after-init . global-display-line-numbers-mode))

(use-package warm-night-theme
  :ensure t
  :config
    (load-theme 'warm-night t)
    ; (set-face-attribute 'default nil :height 140)
    (custom-set-faces '(default ((t (:height 180))))))

; (use-package org-modern-indent
;   :load-path "~/.emacs.d/org-modern-indent/"
;   :hook ; add late to hook
;     (org-mode . org-modern-indent-mode))
